{% extends 'admin/base.html' %}

{% block title %}Review Details - {{ details.access_log.session_id }}{% endblock %}

{% block content %}
    <h2>Review Details for Session: {{ details.access_log.session_id }}</h2>
    <p><a href="{{ url_for('admin_bp.get_pending_reviews') }}">&laquo; Back to Pending Reviews</a></p>
    <hr>

    {# --- Common: Access Log Info --- #}
    <div class="details-section">
        <h3>Access Log Information</h3>
        <table>
            <tr><th>Log ID</th><td>{{ details.access_log.id }}</td></tr>
            <tr><th>Timestamp</th><td>{{ details.access_log.timestamp }}</td></tr>
            <tr><th>Verification Method</th><td><strong>{{ details.access_log.verification_method }}</strong></td></tr>
            <tr><th>Access Granted (Initial)</th><td>{{ details.access_log.access_granted }}</td></tr>
            <tr><th>Verification Confidence</th><td>{{ details.access_log.verification_confidence if details.access_log.verification_confidence is not none else 'N/A' }}</td></tr>
            <tr><th>Current Review Status</th><td>{{ details.access_log.review_status }}</td></tr>
        </table>
    </div>

    {# --- Specific Review Sections based on Method --- #}
    {% set method = details.access_log.verification_method %}

    {# --- RFID_ONLY_PENDING_REVIEW --- #}
    {% if method == 'RFID_ONLY_PENDING_REVIEW' %}
        <div class="details-section">
            <h4>RFID Only Review</h4>
            <p>This session was flagged because an RFID tag was detected, but no face was detected in the captured image.</p>

            {# Employee Info (Should exist for RFID only) #}
            {% if details.employee %}
                <h3>Associated Employee</h3>
                <table>
                    <tr><th>Employee ID</th><td>{{ details.employee.id }}</td></tr>
                    <tr><th>Name</th><td>{{ details.employee.name }}</td></tr>
                    <tr>
                        <th>Reference Photo</th>
                        <td>
                            {% if details.employee.photo_url %}
                                <img src="{{ details.employee.photo_url }}" alt="Reference Photo for {{ details.employee.name }}" style="max-width: 200px; height: auto; border: 1px solid #ccc;">
                            {% else %}
                                <i>No reference photo available.</i>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            {% else %}
                <p class="error">Error: Employee details not found for RFID tag associated with this log.</p>
            {% endif %}

            {# Verification Image (Should exist, but no face) #}
            <h3>Captured Image (No Face Detected)</h3>
            {% include 'admin/_image_display.html' %}
        </div>

    {# --- FACE_ONLY_PENDING_REVIEW --- #}
    {% elif method == 'FACE_ONLY_PENDING_REVIEW' %}
        <div class="details-section">
            <h4>Face Only Review</h4>
            <p>This session was flagged because a face was detected, but no RFID tag was presented.</p>

            {# Verification Image (Should exist) #}
            <h3>Captured Image</h3>
            {% include 'admin/_image_display.html' %}

            {# Potential Matches #}
            <h3>Potential Face Matches</h3>
            {% if details.potential_matches %}
                <form id="face-only-approve-form" class="button-form" action="{{ url_for('admin_bp.approve_review', session_id=details.access_log.session_id) }}" method="post">
                     {# Hidden input to store the selected employee ID #}
                    <input type="hidden" name="selected_employee_id" id="selected-employee-id" value="">

                    <table>
                        <thead>
                            <tr><th>Select</th><th>Employee ID</th><th>Name</th><th>Distance</th><th>Confidence</th></tr>
                        </thead>
                        <tbody>
                            {% for match in details.potential_matches %}
                                <tr>
                                    <td>
                                        <input type="radio" name="match_selection" value="{{ match.employee_id }}" id="match-{{ match.employee_id }}" class="match-radio">
                                    </td>
                                    <td><label for="match-{{ match.employee_id }}">{{ match.employee_id }}</label></td>
                                    <td><label for="match-{{ match.employee_id }}">{{ match.name }}</label></td>
                                    <td>{{ "%.4f"|format(match.distance) }}</td>
                                    <td>{{ "%.4f"|format(match.confidence) }}</td>
                                    {# Removed the old disabled button #}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                     {# Main Approve button, initially disabled for Face-Only #}
                    <button type="submit" class="approve-button" id="face-only-approve-button" disabled>Approve Selected Match</button>
                </form>
            {% else %}
                <p>No potential matches found based on face similarity search.</p>
            {% endif %}
        </div>

    {# --- FACE_VERIFICATION_FAILED --- #}
    {% elif method == 'FACE_VERIFICATION_FAILED' %}
        <div class="details-section">
            <h4>Face Verification Failed Review</h4>
            <p>This session was flagged because RFID and Face were detected, but the face did not match the employee record with sufficient confidence.</p>

            {# Employee Info (Should exist) #}
            {% if details.employee %}
                <h3>Associated Employee (RFID Match)</h3>
                 <table>
                    <tr><th>Employee ID</th><td>{{ details.employee.id }}</td></tr>
                    <tr><th>Name</th><td>{{ details.employee.name }}</td></tr>
                    <tr>
                        <th>Reference Photo</th>
                        <td>
                            {% if details.employee.photo_url %}
                                <img src="{{ details.employee.photo_url }}" alt="Reference Photo for {{ details.employee.name }}" style="max-width: 200px; height: auto; border: 1px solid #ccc;">
                            {% else %}
                                <i>No reference photo available.</i>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            {% else %}
                 <p class="error">Error: Employee details not found for RFID tag associated with this log.</p>
            {% endif %}

            {# Verification Image (Should exist) #}
            <h3>Captured Image (Failed Verification)</h3>
            <p>Confidence Score: {{ details.access_log.verification_confidence if details.access_log.verification_confidence is not none else 'N/A' }}</p>
            {% include 'admin/_image_display.html' %}
        </div>

    {# --- Default/Other Methods --- #}
    {% else %}
        <div class="details-section">
            <h4>Review Details</h4>
            <p>Displaying generic details for verification method: {{ method }}.</p>
            {# Fallback: Show employee if available #}
            {% if details.employee %}
                <h3>Associated Employee</h3>
                <table>
                    <tr><th>Employee ID</th><td>{{ details.employee.id }}</td></tr>
                    <tr><th>Name</th><td>{{ details.employee.name }}</td></tr>
                     <tr>
                        <th>Reference Photo</th>
                        <td>
                            {% if details.employee.photo_url %}
                                <img src="{{ details.employee.photo_url }}" alt="Reference Photo for {{ details.employee.name }}" style="max-width: 200px; height: auto; border: 1px solid #ccc;">
                            {% else %}
                                <i>No reference photo available.</i>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            {% endif %}
            {# Fallback: Show image if available #}
            <h3>Captured Image</h3>
            {% include 'admin/_image_display.html' %}
        </div>
    {% endif %}

    {# --- Common: Admin Actions --- #}
    <div class="details-section">
        <h3>Admin Actions</h3>
        {% if details.access_log.review_status == 'pending' %}
            {# --- Standard Approve/Deny Forms for non-Face-Only cases --- #}
            {% if method != 'FACE_ONLY_PENDING_REVIEW' %}
                <form class="button-form" action="{{ url_for('admin_bp.approve_review', session_id=details.access_log.session_id) }}" method="post">
                    <button type="submit" class="approve-button">Approve Access</button>
                </form>
            {% endif %}
            {# Deny button is always shown for pending reviews #}
            <form class="button-form" action="{{ url_for('admin_bp.deny_review', session_id=details.access_log.session_id) }}" method="post">
                <button type="submit" class="deny-button">Deny Access</button>
            </form>
        {% else %}
            <p>This session has already been reviewed (Status: {{ details.access_log.review_status }}).</p>
        {% endif %}
    </div>

{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Only run this script if it's a Face-Only review
            {% if method == 'FACE_ONLY_PENDING_REVIEW' %}
                const approveButton = document.getElementById('face-only-approve-button');
                const hiddenInput = document.getElementById('selected-employee-id');
                const radioButtons = document.querySelectorAll('.match-radio');

                if (approveButton && hiddenInput && radioButtons.length > 0) {
                    radioButtons.forEach(radio => {
                        radio.addEventListener('change', function() {
                            if (this.checked) {
                                approveButton.disabled = false; // Enable button
                                hiddenInput.value = this.value; // Set hidden input value
                                console.log('Selected employee ID:', this.value);
                            }
                        });
                    });
                } else {
                    console.error('Face-Only approve elements not found.');
                }
            {% endif %}
        });
    </script>
{% endblock %}
